# dockerfy android build

android auto apk building by docker

## Dockerfile

to build an android apk file with docker, we need to create an envrioment which the `jdk` and `android sdk tools` is basically required. it is recommened to do it `FROM` the image of ubuntu.
then we'll need to define envrioment variable as `JAVA_HOME` and `ANDROID_HOME` or even `GRADLE_HOME` if it's used for you, but gralde is not actually what we want, we would rather use [gradlew](../../../manual/gradle.md).<br/>
here is a template of Dockerfile:

```bash
FROM ubuntu:14.04

MAINTAINER zxy

ENV JAVA_HOME /jdk1.8.0_191
ENV ANDROID_HOME /opt/android-sdk-linux/
ENV ANDROID_SDK_FILENAME android-sdk_r24.4.1-linux.tgz
ENV ANDROID_SDK_URL http://dl.google.com/android/${ANDROID_SDK_FILENAME}
ENV PATH ${PATH}:${ANDROID_HOME}/tools:${ANDROID_HOME}/platform-tools:${JAVA_HOME}/bin/

RUN sudo apt-get update && sudo apt-get install -y gcc-multilib lib32z1 lib32stdc++6 wget && apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# jdk can not download directly from official site anymore, get it from other site
# RUN wget https://github.com/simonz19/dockerfiles/releases/download/v1/jdk-8u191-linux-x64.tar.gz
# or just copy from local if already exist
COPY ./jdk-8u191-linux-x64.tar.gz ./

RUN tar -xzf jdk-8u191-linux-x64.tar.gz && \
    rm -rf $JAVA_HOME/src.zip $JAVA_HOME/javafx-src.zip $JAVA_HOME/man /jdk-8u191-linux-x64.tar.gz

RUN cd /opt && \
    wget -q ${ANDROID_SDK_URL} && \
    tar -xzf ${ANDROID_SDK_FILENAME} && \
    rm ${ANDROID_SDK_FILENAME} && \
    echo y | android update sdk --no-ui --all --filter tools,platform-tools,extra-android-m2repository
```

## gradlew

a gradle script generated by android studio, it indicate the version and other configurations of gradle in `your project root/gradle/wrapper/gradle-wrapper.properties` file, this make it a uniform way to run building by specifying gralde config.

## gradlew build progress

- gradlew script will check your gradle version at fist, if not exist locally, a specified version of gradle will be downloading, the downloaded gradle file is loacted in **.gradle/wrapper/** directory.
- then each module's denpendencies specifyied in individual `gralde.build` file will be downloading from maven repository. generally, downloaded dependencies is located in **.gradle/cachesmodules-2/files-2.1/** directory and gradlew is more likely to use local dependency files.
- gradlew use the capacity of gradle to build each module and this will take a lot of time.
- use `build tools` to generate apk file.

## gradlew build accelerate

todo

## errors in build process

### lint error or fetal

-XLint says to turn on full messages for warnings in Java, because without it, you will get only summary warnings.<br/>
if there are build time Xlint errors or fetals, it will turns out a build fetal. fix your lint errors or just disable lint by configure lint options in module's `gradle.build` like this:

```bash
    lintOptions {
        abortOnError false
    }
```

### Could not HEAD https://maven.aliyun.com/repository/google/xxx

sometimes caused by network, just rebuild again.

### Type Error executing aapt: Cannot run program “/opt/android-sdk-linux/build-tools/19.0.1/aapt”: java.io.IOException

do

```bash
apt-get install -y gcc-multilib lib32z1 lib32stdc++6
```

### Gradle build daemon disappeared unexpectedly (it may have been killed or may have crashed)

mostly caused by out of memery, update memery by:

gradle.property:

```bash
org.gradle.jvmargs=-Xmx4096m -XX\:MaxPermSize\=512m -XX\:+HeapDumpOnOutOfMemoryError -Dfile.encoding\=UTF-8
```

app's build.gradle:

```bash
    dexOptions {
        incremental true
        javaMaxHeapSize "2048M"
    }
```

if docker runs in virtual machine, then configure your virtual machine's memery.
